<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>remotionBinário Studio</title>

    <!-- Monaco Editor from CDN -->
    <link rel="stylesheet" data-name="vs/editor/editor.main"
        href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        /* ═══════════════════════════════════════════
       DESIGN SYSTEM — remotionBinário Studio
       ═══════════════════════════════════════════ */
        :root {
            --bg-primary: #07070d;
            --bg-secondary: #0d0d16;
            --bg-panel: rgba(14, 14, 24, 0.85);
            --bg-panel-hover: rgba(20, 20, 35, 0.9);
            --border: rgba(255, 255, 255, 0.06);
            --border-active: rgba(0, 255, 136, 0.3);
            --accent: #00ff88;
            --accent-dim: rgba(0, 255, 136, 0.15);
            --accent-glow: rgba(0, 255, 136, 0.08);
            --text-primary: #e8e8f0;
            --text-secondary: #6b6b80;
            --text-muted: #3a3a50;
            --danger: #ff4466;
            --warning: #ffaa22;
            --info: #44aaff;
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* ─── Layout Grid ─── */
        .studio-layout {
            display: grid;
            grid-template-columns: 240px 1fr 340px;
            grid-template-rows: 52px 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        /* ─── Top Bar ─── */
        .topbar {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
            border-bottom: 1px solid var(--border);
        }

        .topbar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--accent);
            letter-spacing: 0.03em;
        }

        .topbar-logo .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 8px var(--accent);
            }

            50% {
                opacity: 0.5;
                box-shadow: 0 0 16px var(--accent);
            }
        }

        .topbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
        }

        .topbar-status {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .topbar-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        /* ─── Buttons ─── */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--bg-panel-hover);
            border-color: var(--border-active);
        }

        .btn-accent {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
            font-weight: 600;
        }

        .btn-accent:hover {
            background: #33ffaa;
            box-shadow: 0 0 20px var(--accent-dim);
        }

        .btn-danger {
            color: var(--danger);
            border-color: rgba(255, 68, 102, 0.2);
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
        }

        /* ─── Sidebar ─── */
        .sidebar {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-left: 2px solid transparent;
        }

        .sidebar-item:hover {
            background: var(--accent-glow);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: var(--accent-glow);
            color: var(--accent);
            border-left-color: var(--accent);
        }

        .sidebar-item .size {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ─── Center Panel (Editor + Tools) ─── */
        .center-panel {
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            min-height: 36px;
        }

        .editor-tab {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .editor-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            transition: var(--transition);
        }

        .editor-indicator.rendering {
            background: var(--warning);
            animation: pulse 0.5s ease-in-out infinite;
        }

        .editor-indicator.error {
            background: var(--danger);
        }

        #editor-container {
            flex: 1;
            min-height: 0;
        }

        /* ─── Tools Bar (below editor) ─── */
        .tools-bar {
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            max-height: 200px;
            overflow: hidden;
        }

        .tools-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }

        .tools-tab {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tools-tab:hover {
            color: var(--text-primary);
        }

        .tools-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tools-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .tool-panel {
            display: none;
        }

        .tool-panel.active {
            display: block;
        }

        /* SVG Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-glow);
            color: var(--accent);
        }

        .drop-zone i {
            margin-bottom: 8px;
        }

        .import-options {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .import-options label {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .import-options input[type="checkbox"] {
            accent-color: var(--accent);
        }

        .import-options input[type="number"] {
            width: 60px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Export Buttons */
        .export-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* ─── Right Panel (Preview + Info) ─── */
        .right-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-block {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* OLED Simulator */
        .oled-frame {
            background: #000;
            border-radius: 6px;
            padding: 8px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow:
                0 0 0 2px #1a1a2e,
                0 0 0 4px #0d0d16,
                0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .oled-screen {
            position: relative;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .oled-screen img {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* Screen door effect overlay */
        .oled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.15) 1px, transparent 1px);
            background-size: 4px 4px;
            opacity: 0.4;
            mix-blend-mode: multiply;
            border-radius: 2px;
        }

        .oled-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* Color Modes */
        .color-modes {
            display: flex;
            gap: 6px;
            margin-top: 16px;
            justify-content: center;
        }

        .color-mode {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .color-mode:hover,
        .color-mode.active {
            border-color: var(--text-primary);
            transform: scale(1.15);
        }

        .color-mode.white {
            background: #fff;
        }

        .color-mode.blue {
            background: #00aaff;
        }

        .color-mode.yellow {
            background: #ffcc00;
        }

        .color-mode.green {
            background: var(--accent);
        }

        /* Player Controls */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .player-controls input[type="range"] {
            flex: 1;
            accent-color: var(--accent);
            height: 3px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        .player-info .accent {
            color: var(--accent);
        }

        /* Memory Visualizer */
        .memory-bar-container {
            margin-top: 8px;
        }

        .memory-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .memory-bar-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--accent), #44aaff);
            transition: width 0.5s ease;
            width: 0%;
        }

        .memory-bar-fill.warn {
            background: linear-gradient(90deg, var(--warning), var(--danger));
        }

        .memory-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .memory-stat {
            background: var(--bg-primary);
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .memory-stat .label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .memory-stat .value {
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            margin-top: 2px;
        }

        /* Assets Grid */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .asset-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .asset-card:hover {
            border-color: var(--border-active);
            transform: translateY(-1px);
        }

        .asset-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            image-rendering: pixelated;
            background: #000;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .asset-card .name {
            font-size: 9px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Error Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-panel);
            border: 1px solid var(--danger);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            z-index: 999;
            transition: transform 0.3s ease;
            backdrop-filter: blur(12px);
            max-width: 500px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: var(--accent);
        }

        .toast.info {
            border-color: var(--info);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            gap: 8px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Dropdown */
        select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>

<body>
    <div class="studio-layout">

        <!-- ═══ TOP BAR ═══ -->
        <header class="topbar">
            <div class="topbar-logo">
                <div class="dot"></div>
                remotionBinário <span style="color:var(--text-muted); font-weight:400">Studio</span>
            </div>
            <div class="topbar-divider"></div>
            <span class="topbar-status" id="topbar-status">Ready</span>
            <div class="topbar-actions">
                <button class="btn btn-sm" onclick="saveCurrentScene()">
                    <i data-lucide="save" style="width:14px;height:14px"></i> Salvar
                </button>
                <button class="btn btn-sm" onclick="createNewScene()">
                    <i data-lucide="file-plus" style="width:14px;height:14px"></i> Novo
                </button>
            </div>
        </header>

        <!-- ═══ SIDEBAR ═══ -->
        <aside class="sidebar">
            <div class="sidebar-section" style="flex:1">
                <div class="sidebar-header">
                    <span><i data-lucide="layers" style="width:12px;height:12px;vertical-align:-2px"></i> Cenas</span>
                    <button class="btn btn-sm" onclick="loadScenes()" style="padding:2px 6px">
                        <i data-lucide="refresh-cw" style="width:10px;height:10px"></i>
                    </button>
                </div>
                <div class="sidebar-list" id="scene-list">
                    <div class="empty-state">
                        <i data-lucide="loader" style="width:16px;height:16px"></i>
                        Carregando...
                    </div>
                </div>
            </div>

            <div class="sidebar-section" style="flex:1;border-top:1px solid var(--border)">
                <div class="sidebar-header">
                    <span><i data-lucide="image" style="width:12px;height:12px;vertical-align:-2px"></i> Assets</span>
                    <button class="btn btn-sm" onclick="loadAssets()" style="padding:2px 6px">
                        <i data-lucide="refresh-cw" style="width:10px;height:10px"></i>
                    </button>
                </div>
                <div class="sidebar-list" id="assets-list">
                    <div class="empty-state">
                        <i data-lucide="image-off" style="width:16px;height:16px"></i>
                        Nenhum asset
                    </div>
                </div>
            </div>
        </aside>

        <!-- ═══ CENTER (Editor + Tools) ═══ -->
        <main class="center-panel">
            <div class="editor-header">
                <div class="editor-indicator" id="editor-indicator"></div>
                <span class="editor-tab" id="editor-tab">untitled.yaml</span>
                <span
                    style="margin-left:auto;font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace"
                    id="editor-status">
                    Hot Reload: ON
                </span>
            </div>
            <div id="editor-container"></div>

            <!-- Tools Bar -->
            <div class="tools-bar">
                <div class="tools-tabs">
                    <div class="tools-tab active" data-tab="svg-import">
                        <i data-lucide="upload" style="width:12px;height:12px"></i> SVG Import
                    </div>
                    <div class="tools-tab" data-tab="export">
                        <i data-lucide="download" style="width:12px;height:12px"></i> Exportar
                    </div>
                </div>

                <div class="tools-content">
                    <!-- SVG Import Panel -->
                    <div class="tool-panel active" id="panel-svg-import">
                        <div class="drop-zone" id="svg-drop-zone">
                            <i data-lucide="upload-cloud"
                                style="width:24px;height:24px;display:block;margin:0 auto 8px"></i>
                            Arraste um SVG aqui ou clique para selecionar
                            <input type="file" accept=".svg" id="svg-file-input" style="display:none">
                        </div>
                        <div class="import-options">
                            <label><input type="number" id="import-width" value="64" min="8" max="256" step="8">
                                largura</label>
                            <label><input type="checkbox" id="import-dither"> Dithering</label>
                            <label><input type="checkbox" id="import-invert"> Inverter</label>
                        </div>
                    </div>

                    <!-- Export Panel -->
                    <div class="tool-panel" id="panel-export">
                        <div class="export-grid">
                            <button class="btn" onclick="exportScene('c_array')">
                                <i data-lucide="file-code" style="width:14px;height:14px"></i> C-Array (.h)
                            </button>
                            <button class="btn" onclick="exportScene('delta')">
                                <i data-lucide="git-branch" style="width:14px;height:14px"></i> Delta (.h)
                            </button>
                            <button class="btn" onclick="exportScene('gif')">
                                <i data-lucide="film" style="width:14px;height:14px"></i> GIF
                            </button>
                        </div>
                        <div class="import-options" style="margin-top:8px">
                            <label>Formato:
                                <select id="export-format">
                                    <option value="horizontal">Horizontal (Adafruit)</option>
                                    <option value="vertical">Vertical (ST7565)</option>
                                    <option value="page">Page (U8g2)</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ═══ RIGHT PANEL (Preview + Info) ═══ -->
        <aside class="right-panel">

            <!-- OLED Preview -->
            <div class="panel-block">
                <div class="panel-title">
                    <i data-lucide="monitor" style="width:12px;height:12px"></i> OLED Preview
                </div>
                <div class="oled-frame" id="oled-frame">
                    <div class="oled-screen" id="oled-screen">
                        <img id="preview-img" src="" alt="OLED Preview" style="display:none">
                        <div class="oled-overlay" id="oled-overlay"></div>
                    </div>
                    <div class="empty-state" id="preview-empty" style="padding:40px 20px">
                        <i data-lucide="monitor" style="width:24px;height:24px"></i>
                        Edite o YAML para ver o preview
                    </div>
                </div>

                <div class="color-modes">
                    <div class="color-mode white active" data-color="white" title="Branco"></div>
                    <div class="color-mode blue" data-color="blue" title="Azul"></div>
                    <div class="color-mode yellow" data-color="yellow" title="Amarelo"></div>
                    <div class="color-mode green" data-color="green" title="Verde"></div>
                </div>

                <div class="player-controls" id="player-controls" style="display:none">
                    <button class="btn btn-sm" id="btn-prev" title="Frame anterior">
                        <i data-lucide="skip-back" style="width:12px;height:12px"></i>
                    </button>
                    <button class="btn btn-sm btn-accent" id="btn-play" title="Play/Pause">
                        <i data-lucide="play" style="width:12px;height:12px" id="play-icon"></i>
                    </button>
                    <button class="btn btn-sm" id="btn-next" title="Próximo frame">
                        <i data-lucide="skip-forward" style="width:12px;height:12px"></i>
                    </button>
                    <input type="range" id="frame-slider" min="0" value="0">
                </div>
                <div class="player-info" id="player-info" style="display:none">
                    <span>Frame <span class="accent" id="frame-num">0</span> / <span id="frame-total">0</span></span>
                    <span><span class="accent" id="preview-fps">0</span> FPS</span>
                </div>
            </div>

            <!-- Memory -->
            <div class="panel-block" id="memory-panel" style="display:none">
                <div class="panel-title">
                    <i data-lucide="cpu" style="width:12px;height:12px"></i> Memória ESP32
                </div>
                <div class="memory-bar-container">
                    <div class="memory-bar">
                        <div class="memory-bar-fill" id="memory-fill"></div>
                    </div>
                </div>
                <div class="memory-stats">
                    <div class="memory-stat">
                        <div class="label">Total</div>
                        <div class="value" id="mem-total">0 KB</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Flash Usada</div>
                        <div class="value" id="mem-pct">0%</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Por Frame</div>
                        <div class="value" id="mem-frame">0 B</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Frames</div>
                        <div class="value" id="mem-frames">0</div>
                    </div>
                </div>
            </div>

            <!-- Scene Info -->
            <div class="panel-block" id="scene-info-panel" style="display:none">
                <div class="panel-title">
                    <i data-lucide="info" style="width:12px;height:12px"></i> Informações
                </div>
                <div class="memory-stats">
                    <div class="memory-stat">
                        <div class="label">Resolução</div>
                        <div class="value" id="info-resolution">--</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Dimensão</div>
                        <div class="value" id="info-dimension">--</div>
                    </div>
                </div>
            </div>
        </aside>

    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Monaco Loader -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <script>
        // ═══════════════════════════════════════════
        // STATE
        // ═══════════════════════════════════════════
        let editor = null;
        let currentScene = null;
        let frames = [];
        let currentFrame = 0;
        let playing = false;
        let playInterval = null;
        let renderTimeout = null;
        let oledColor = 'white';
        const DEBOUNCE_MS = 600;

        const DEFAULT_YAML = `screen:
  width: 128
  height: 64
  fps: 15
  frames: 30

elements:
  - type: circle
    id: ball
    props:
      cx: 20
      cy: 32
      r: 8
      fill: true
    keyframes:
      - frame: 0
        cx: 20
        easing: "ease-in-out"
      - frame: 15
        cx: 108
      - frame: 29
        cx: 20

output:
  c_array: true
  gif: true
  format: "horizontal"
  delta_compression: true
`;

        // ═══════════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════════
        require.config({
            paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }
        });

        window.MonacoEnvironment = {
            getWorkerUrl: (moduleId, label) =>
                `data:text/javascript;charset=utf-8,${encodeURIComponent(
                    `self.MonacoEnvironment={baseUrl:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/"};importScripts("https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/worker/workerMain.js");`
                )}`
        };

        require(['vs/editor/editor.main'], function () {
            // YAML Theme
            monaco.editor.defineTheme('remotion-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'string', foreground: '00ff88' },
                    { token: 'number', foreground: '44aaff' },
                    { token: 'keyword', foreground: 'ffaa22' },
                    { token: 'comment', foreground: '3a3a50' },
                    { token: 'type', foreground: 'ff4466' },
                ],
                colors: {
                    'editor.background': '#07070d',
                    'editor.foreground': '#e8e8f0',
                    'editorCursor.foreground': '#00ff88',
                    'editor.lineHighlightBackground': '#0d0d1680',
                    'editor.selectionBackground': '#00ff8820',
                    'editorLineNumber.foreground': '#3a3a50',
                    'editorLineNumber.activeForeground': '#6b6b80',
                    'editor.findMatchBackground': '#00ff8830',
                    'editor.findMatchHighlightBackground': '#00ff8815',
                }
            });

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: DEFAULT_YAML,
                language: 'yaml',
                theme: 'remotion-dark',
                fontSize: 13,
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                fontLigatures: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                renderLineHighlight: 'gutter',
                lineNumbers: 'on',
                tabSize: 2,
                wordWrap: 'on',
                padding: { top: 12 },
                smoothScrolling: true,
                cursorBlinking: 'smooth',
                cursorSmoothCaretAnimation: 'on',
            });

            // Hot Reload: debounce on content change
            editor.onDidChangeModelContent(() => {
                clearTimeout(renderTimeout);
                setIndicator('rendering');
                renderTimeout = setTimeout(() => renderCurrentYaml(), DEBOUNCE_MS);
            });

            // Initial render
            renderCurrentYaml();
            loadScenes();
            loadAssets();
        });

        // Init Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupDropZone();
            setupToolsTabs();
            setupColorModes();
            setupPlayerControls();
        });

        // ═══════════════════════════════════════════
        // RENDERING
        // ═══════════════════════════════════════════
        async function renderCurrentYaml() {
            const yaml = editor.getValue();
            if (!yaml.trim()) return;

            setStatus('Renderizando...');
            setIndicator('rendering');

            try {
                const res = await fetch('/api/render', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ yaml, scale: 3 }),
                });

                const data = await res.json();

                if (data.error) {
                    setIndicator('error');
                    setStatus(`Erro: ${data.error}`);
                    showToast(data.error, 'error');
                    return;
                }

                frames = data.frames.map(b64 => `data:image/png;base64,${b64}`);
                currentFrame = 0;

                // Update preview
                document.getElementById('preview-empty').style.display = 'none';
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('preview-img').style.width = data.scaled_width + 'px';
                document.getElementById('preview-img').style.height = data.scaled_height + 'px';
                document.getElementById('player-controls').style.display = 'flex';
                document.getElementById('player-info').style.display = 'flex';
                document.getElementById('frame-slider').max = frames.length - 1;
                document.getElementById('frame-total').textContent = frames.length;
                document.getElementById('preview-fps').textContent = data.fps;

                // Update memory
                updateMemory(data.memory);

                // Update scene info
                document.getElementById('scene-info-panel').style.display = 'block';
                document.getElementById('info-resolution').textContent = `${data.width}×${data.height}`;
                document.getElementById('info-dimension').textContent = `${data.scaled_width}×${data.scaled_height}`;

                // Apply color filter
                applyOledColor();
                showFrame(0);

                // Auto-play
                if (!playing) togglePlay();

                setIndicator('ok');
                setStatus(`${frames.length} frames @ ${data.fps} FPS`);

            } catch (err) {
                setIndicator('error');
                setStatus('Erro de conexão');
                showToast('Erro ao renderizar: ' + err.message, 'error');
            }
        }

        function showFrame(i) {
            if (frames.length === 0) return;
            currentFrame = i;
            document.getElementById('preview-img').src = frames[i];
            document.getElementById('frame-slider').value = i;
            document.getElementById('frame-num').textContent = i + 1;
        }

        // ═══════════════════════════════════════════
        // PLAYER
        // ═══════════════════════════════════════════
        function setupPlayerControls() {
            document.getElementById('btn-play').addEventListener('click', togglePlay);
            document.getElementById('btn-prev').addEventListener('click', () => {
                stopPlay();
                showFrame((currentFrame - 1 + frames.length) % frames.length);
            });
            document.getElementById('btn-next').addEventListener('click', () => {
                stopPlay();
                showFrame((currentFrame + 1) % frames.length);
            });
            document.getElementById('frame-slider').addEventListener('input', e => {
                stopPlay();
                showFrame(parseInt(e.target.value));
            });
        }

        function togglePlay() {
            playing = !playing;
            const icon = document.getElementById('play-icon');
            if (playing) {
                icon.setAttribute('data-lucide', 'pause');
                const fps = parseInt(document.getElementById('preview-fps').textContent) || 15;
                playInterval = setInterval(() => {
                    showFrame((currentFrame + 1) % frames.length);
                }, 1000 / fps);
            } else {
                icon.setAttribute('data-lucide', 'play');
                clearInterval(playInterval);
            }
            lucide.createIcons();
        }

        function stopPlay() {
            playing = false;
            clearInterval(playInterval);
            const icon = document.getElementById('play-icon');
            icon.setAttribute('data-lucide', 'play');
            lucide.createIcons();
        }

        // ═══════════════════════════════════════════
        // OLED COLOR
        // ═══════════════════════════════════════════
        function setupColorModes() {
            document.querySelectorAll('.color-mode').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.color-mode').forEach(e => e.classList.remove('active'));
                    el.classList.add('active');
                    oledColor = el.dataset.color;
                    applyOledColor();
                });
            });
        }

        function applyOledColor() {
            const img = document.getElementById('preview-img');
            const colorMap = {
                white: 'none',
                blue: 'sepia(100%) saturate(300%) brightness(70%) hue-rotate(180deg)',
                yellow: 'sepia(100%) saturate(500%) brightness(100%) hue-rotate(10deg)',
                green: 'sepia(100%) saturate(300%) brightness(80%) hue-rotate(90deg)',
            };
            img.style.filter = colorMap[oledColor] || 'none';
        }

        // ═══════════════════════════════════════════
        // MEMORY
        // ═══════════════════════════════════════════
        function updateMemory(mem) {
            if (!mem) return;
            document.getElementById('memory-panel').style.display = 'block';
            document.getElementById('mem-total').textContent = mem.total_kb + ' KB';
            document.getElementById('mem-pct').textContent = mem.flash_pct + '%';
            document.getElementById('mem-frame').textContent = mem.frame_bytes + ' B';
            document.getElementById('mem-frames').textContent = frames.length;

            const fill = document.getElementById('memory-fill');
            fill.style.width = Math.min(mem.flash_pct, 100) + '%';
            fill.classList.toggle('warn', mem.flash_pct > 50);
        }

        // ═══════════════════════════════════════════
        // SCENES
        // ═══════════════════════════════════════════
        async function loadScenes() {
            try {
                const res = await fetch('/api/scenes');
                const scenes = await res.json();
                const list = document.getElementById('scene-list');

                if (scenes.length === 0) {
                    list.innerHTML = '<div class="empty-state"><i data-lucide="folder-open" style="width:16px;height:16px"></i>Nenhuma cena</div>';
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = scenes.map(s => `
          <div class="sidebar-item" data-scene="${s.name}" onclick="openScene('${s.name}')">
            <i data-lucide="file-text" style="width:14px;height:14px;flex-shrink:0"></i>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.name}</span>
            <span class="size">${(s.size / 1024).toFixed(1)}K</span>
          </div>
        `).join('');
                lucide.createIcons();
            } catch (err) {
                console.error('Failed to load scenes:', err);
            }
        }

        async function openScene(name) {
            try {
                const res = await fetch(`/api/scenes/${name}`);
                const data = await res.json();
                editor.setValue(data.content);
                currentScene = name;
                document.getElementById('editor-tab').textContent = name;

                // Highlight sidebar
                document.querySelectorAll('.sidebar-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.scene === name);
                });

                setStatus(`Aberto: ${name}`);
            } catch (err) {
                showToast('Erro ao abrir cena', 'error');
            }
        }

        async function saveCurrentScene() {
            if (!currentScene) {
                const name = prompt('Nome do arquivo (ex: minha_cena.yaml):');
                if (!name) return;
                currentScene = name.endsWith('.yaml') ? name : name + '.yaml';
            }

            try {
                await fetch(`/api/scenes/${currentScene}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: editor.getValue() }),
                });
                document.getElementById('editor-tab').textContent = currentScene;
                showToast(`Salvo: ${currentScene}`, 'success');
                loadScenes();
            } catch (err) {
                showToast('Erro ao salvar', 'error');
            }
        }

        function createNewScene() {
            currentScene = null;
            editor.setValue(DEFAULT_YAML);
            document.getElementById('editor-tab').textContent = 'untitled.yaml';
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        }

        // ═══════════════════════════════════════════
        // ASSETS
        // ═══════════════════════════════════════════
        async function loadAssets() {
            try {
                const res = await fetch('/api/assets');
                const assets = await res.json();
                const list = document.getElementById('assets-list');

                const images = assets.filter(a => ['.png', '.svg'].includes(a.type));

                if (images.length === 0) {
                    list.innerHTML = '<div class="empty-state"><i data-lucide="image-off" style="width:16px;height:16px"></i>Importe um SVG</div>';
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = '<div class="assets-grid" style="padding:8px">' +
                    images.map(a => `
            <div class="asset-card" onclick="insertAsset('${a.name}')" title="Clique para inserir no YAML">
              <img src="${a.url}" alt="${a.name}">
              <div class="name">${a.name}</div>
            </div>
          `).join('') + '</div>';
                lucide.createIcons();
            } catch (err) {
                console.error('Failed to load assets:', err);
            }
        }

        function insertAsset(name) {
            const snippet = `  - type: sprite\n    id: ${name.replace(/\.[^.]+$/, '')}\n    props:\n      x: 0\n      y: 0\n      src: "assets/${name}"\n`;
            const pos = editor.getPosition();
            editor.executeEdits('', [{
                range: new monaco.Range(pos.lineNumber, 1, pos.lineNumber, 1),
                text: snippet,
            }]);
            showToast(`Asset "${name}" inserido`, 'success');
        }

        // ═══════════════════════════════════════════
        // SVG IMPORT
        // ═══════════════════════════════════════════
        function setupDropZone() {
            const zone = document.getElementById('svg-drop-zone');
            const input = document.getElementById('svg-file-input');

            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    uploadSVG(e.dataTransfer.files[0]);
                }
            });
            input.addEventListener('change', e => {
                if (e.target.files.length) uploadSVG(e.target.files[0]);
            });
        }

        async function uploadSVG(file) {
            if (!file.name.toLowerCase().endsWith('.svg')) {
                showToast('Apenas arquivos SVG são aceitos', 'error');
                return;
            }

            setStatus('Importando SVG...');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('width', document.getElementById('import-width').value);
            formData.append('dither', document.getElementById('import-dither').checked);
            formData.append('invert', document.getElementById('import-invert').checked);

            try {
                const res = await fetch('/api/svg-import', {
                    method: 'POST',
                    body: formData,
                });

                const data = await res.json();
                if (data.error) {
                    showToast('Erro: ' + data.error, 'error');
                    return;
                }

                // Insert YAML snippet at cursor
                if (data.yaml_snippet) {
                    const pos = editor.getPosition();
                    editor.executeEdits('', [{
                        range: new monaco.Range(pos.lineNumber, 1, pos.lineNumber, 1),
                        text: data.yaml_snippet + '\n',
                    }]);
                }

                showToast(`SVG importado: ${file.name}`, 'success');
                loadAssets();
                setStatus('SVG importado com sucesso');
            } catch (err) {
                showToast('Erro ao importar SVG', 'error');
            }
        }

        // ═══════════════════════════════════════════
        // EXPORT
        // ═══════════════════════════════════════════
        async function exportScene(type) {
            const yaml = editor.getValue();
            setStatus(`Exportando ${type}...`);

            try {
                const res = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        yaml,
                        type,
                        format: document.getElementById('export-format').value,
                    }),
                });

                if (!res.ok) {
                    const err = await res.json();
                    showToast('Erro: ' + (err.error || 'Falha na exportação'), 'error');
                    return;
                }

                // Download
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = res.headers.get('Content-Disposition')?.split('filename=')[1] || `export.${type === 'gif' ? 'gif' : 'h'}`;
                a.click();
                URL.revokeObjectURL(url);

                showToast(`Exportado: ${type}`, 'success');
                setStatus('Pronto');
            } catch (err) {
                showToast('Erro na exportação', 'error');
            }
        }

        // ═══════════════════════════════════════════
        // TOOLS TABS
        // ═══════════════════════════════════════════
        function setupToolsTabs() {
            document.querySelectorAll('.tools-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tools-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }

        // ═══════════════════════════════════════════
        // UI HELPERS
        // ═══════════════════════════════════════════
        function setStatus(text) {
            document.getElementById('topbar-status').textContent = text;
        }

        function setIndicator(state) {
            const el = document.getElementById('editor-indicator');
            el.className = 'editor-indicator';
            if (state === 'rendering') el.classList.add('rendering');
            else if (state === 'error') el.classList.add('error');
            // 'ok' = default green dot
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>