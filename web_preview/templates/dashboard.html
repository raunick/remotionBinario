<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>remotionBinário Studio</title>

    <!-- Monaco Editor from CDN -->
    <link rel="stylesheet" data-name="vs/editor/editor.main"
        href="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/editor/editor.main.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        /* ═══════════════════════════════════════════
       DESIGN SYSTEM — remotionBinário Studio
       ═══════════════════════════════════════════ */
        :root {
            --bg-primary: #07070d;
            --bg-secondary: #0d0d16;
            --bg-panel: rgba(14, 14, 24, 0.85);
            --bg-panel-hover: rgba(20, 20, 35, 0.9);
            --border: rgba(255, 255, 255, 0.06);
            --border-active: rgba(0, 255, 136, 0.3);
            --accent: #00ff88;
            --accent-dim: rgba(0, 255, 136, 0.15);
            --accent-glow: rgba(0, 255, 136, 0.08);
            --text-primary: #e8e8f0;
            --text-secondary: #6b6b80;
            --text-muted: #3a3a50;
            --danger: #ff4466;
            --warning: #ffaa22;
            --info: #44aaff;
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* ─── Layout Grid ─── */
        .studio-layout {
            display: grid;
            grid-template-columns: 240px 1fr 340px;
            grid-template-rows: 52px 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        /* ─── Top Bar ─── */
        .topbar {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 16px;
            border-bottom: 1px solid var(--border);
        }

        .topbar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--accent);
            letter-spacing: 0.03em;
        }

        .topbar-logo .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 8px var(--accent);
            }

            50% {
                opacity: 0.5;
                box-shadow: 0 0 16px var(--accent);
            }
        }

        .topbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
        }

        .topbar-status {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .topbar-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        /* ─── Buttons ─── */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .btn:hover {
            background: var(--bg-panel-hover);
            border-color: var(--border-active);
        }

        .btn-accent {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
            font-weight: 600;
        }

        .btn-accent:hover {
            background: #33ffaa;
            box-shadow: 0 0 20px var(--accent-dim);
        }

        .btn-danger {
            color: var(--danger);
            border-color: rgba(255, 68, 102, 0.2);
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
        }

        /* ─── Sidebar ─── */
        .sidebar {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border-left: 2px solid transparent;
        }

        .sidebar-item:hover {
            background: var(--accent-glow);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: var(--accent-glow);
            color: var(--accent);
            border-left-color: var(--accent);
        }

        .sidebar-item .size {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ─── Center Panel (Editor + Tools) ─── */
        .center-panel {
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            /* overflow: hidden; */
            min-height: 0;
            min-width: 0;
        }

        .editor-header {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            min-height: 36px;
        }

        .editor-tab {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .editor-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            transition: var(--transition);
        }

        .editor-indicator.rendering {
            background: var(--warning);
            animation: pulse 0.5s ease-in-out infinite;
        }

        .editor-indicator.error {
            background: var(--danger);
        }

        #editor-container {
            flex: 1;
            min-height: 0;
        }

        /* ─── Tools Bar (below editor) ─── */
        .tools-bar {
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            max-height: 200px;
            overflow: hidden;
        }

        .tools-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }

        .tools-tab {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tools-tab:hover {
            color: var(--text-primary);
        }

        .tools-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tools-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .tool-panel {
            display: none;
        }

        .tool-panel.active {
            display: block;
        }

        /* SVG Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-glow);
            color: var(--accent);
        }

        .drop-zone i {
            margin-bottom: 8px;
        }

        .import-options {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .import-options label {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .import-options input[type="checkbox"] {
            accent-color: var(--accent);
        }

        .import-options input[type="number"] {
            width: 60px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Export Buttons */
        .export-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* ─── Right Panel (Preview + Info) ─── */
        .right-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .panel-block {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* OLED Simulator */
        .oled-frame {
            background: #000;
            border-radius: 6px;
            padding: 8px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow:
                0 0 0 2px #1a1a2e,
                0 0 0 4px #0d0d16,
                0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .oled-screen {
            position: relative;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .oled-screen img {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* Screen door effect overlay */
        .oled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.15) 1px, transparent 1px);
            background-size: 4px 4px;
            opacity: 0.4;
            mix-blend-mode: multiply;
            border-radius: 2px;
        }

        .oled-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* Color Modes */
        .color-modes {
            display: flex;
            gap: 6px;
            margin-top: 16px;
            justify-content: center;
        }

        .color-mode {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }

        .color-mode:hover,
        .color-mode.active {
            border-color: var(--text-primary);
            transform: scale(1.15);
        }

        .color-mode.white {
            background: #fff;
        }

        .color-mode.blue {
            background: #00aaff;
        }

        .color-mode.yellow {
            background: #ffcc00;
        }

        .color-mode.green {
            background: var(--accent);
        }

        /* Player Controls */
        .player-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .player-controls input[type="range"] {
            flex: 1;
            accent-color: var(--accent);
            height: 3px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        .player-info .accent {
            color: var(--accent);
        }

        /* Memory Visualizer */
        .memory-bar-container {
            margin-top: 8px;
        }

        .memory-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .memory-bar-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--accent), #44aaff);
            transition: width 0.5s ease;
            width: 0%;
        }

        .memory-bar-fill.warn {
            background: linear-gradient(90deg, var(--warning), var(--danger));
        }

        .memory-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .memory-stat {
            background: var(--bg-primary);
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .memory-stat .label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .memory-stat .value {
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            margin-top: 2px;
        }

        /* Assets Grid */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .asset-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .asset-card:hover {
            border-color: var(--border-active);
            transform: translateY(-1px);
        }

        .asset-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            image-rendering: pixelated;
            background: #000;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .asset-card .name {
            font-size: 9px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Error Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-panel);
            border: 1px solid var(--danger);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            z-index: 999;
            transition: transform 0.3s ease;
            backdrop-filter: blur(12px);
            max-width: 500px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: var(--accent);
        }

        .toast.info {
            border-color: var(--info);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            gap: 8px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Dropdown */
        select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Workspaces */
        .workspace {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            flex: 1;
            min-height: 0;
            min-width: 0;
        }

        .workspace.active {
            display: flex;
        }

        .header-tab-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .header-tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-panel-hover);
        }

        .header-tab-btn.active {
            background: var(--bg-panel);
            color: var(--accent);
            border-color: var(--border);
        }
    </style>
</head>

<body>
    <div class="studio-layout">

        <!-- ═══ TOP BAR ═══ -->
        <header class="topbar">
            <div class="topbar-logo">
                <div class="dot"></div>
                remotionBinário <span style="color:var(--text-muted); font-weight:400">Studio</span>
            </div>
            <div class="topbar-divider"></div>
            <span class="topbar-status" id="topbar-status">Ready</span>
            <div class="topbar-actions">
                <button class="btn btn-sm" onclick="saveCurrentScene()">
                    <i data-lucide="save" style="width:14px;height:14px"></i> Salvar
                </button>
                <button class="btn btn-sm" onclick="createNewScene()">
                    <i data-lucide="file-plus" style="width:14px;height:14px"></i> Novo
                </button>
            </div>
        </header>

        <!-- ═══ SIDEBAR ═══ -->
        <aside class="sidebar">
            <div class="sidebar-section" style="flex:1">
                <div class="sidebar-header">
                    <span><i data-lucide="layers" style="width:12px;height:12px;vertical-align:-2px"></i> Cenas</span>
                    <button class="btn btn-sm" onclick="loadScenes()" style="padding:2px 6px">
                        <i data-lucide="refresh-cw" style="width:10px;height:10px"></i>
                    </button>
                </div>
                <div class="sidebar-list" id="scene-list">
                    <div class="empty-state">
                        <i data-lucide="loader" style="width:16px;height:16px"></i>
                        Carregando...
                    </div>
                </div>
            </div>

            <div class="sidebar-section" style="flex:1;border-top:1px solid var(--border)">
                <div class="sidebar-header">
                    <span><i data-lucide="image" style="width:12px;height:12px;vertical-align:-2px"></i> Assets</span>
                    <button class="btn btn-sm" onclick="loadAssets()" style="padding:2px 6px">
                        <i data-lucide="refresh-cw" style="width:10px;height:10px"></i>
                    </button>
                </div>
                <div class="sidebar-list" id="assets-list">
                    <div class="empty-state">
                        <i data-lucide="image-off" style="width:16px;height:16px"></i>
                        Nenhum asset
                    </div>
                </div>
            </div>
        </aside>

        <!-- ═══ CENTER (Editor + Tools) ═══ -->
        <main class="center-panel">
            <div class="editor-header">
                <div class="editor-indicator" id="editor-indicator"></div>
                <span class="editor-tab" id="editor-tab" style="margin-right:20px">untitled.yaml</span>

                <div style="display:flex; gap:4px">
                    <button class="header-tab-btn active" data-ws="code" onclick="switchWorkspace('code')">
                        <i data-lucide="code" style="width:12px;height:12px"></i> Code
                    </button>
                    <button class="header-tab-btn" data-ws="canvas" onclick="switchWorkspace('canvas')">
                        <i data-lucide="edit-3" style="width:12px;height:12px"></i> Canvas
                    </button>
                    <button class="header-tab-btn" data-ws="image2cpp" onclick="switchWorkspace('image2cpp')">
                        <i data-lucide="image" style="width:12px;height:12px"></i> Image2CPP
                    </button>
                </div>

                <span
                    style="margin-left:auto;font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace"
                    id="editor-status">
                    Hot Reload: ON
                </span>
            </div>

            <!-- CODE WORKSPACE -->
            <div id="workspace-code" class="workspace active">
                <div id="editor-container"></div>

                <!-- Tools Bar -->
                <div class="tools-bar">
                    <div class="tools-tabs">
                        <div class="tools-tab active" data-tab="svg-import">
                            <i data-lucide="upload" style="width:12px;height:12px"></i> SVG Import
                        </div>
                        <div class="tools-tab" data-tab="export">
                            <i data-lucide="download" style="width:12px;height:12px"></i> Exportar
                        </div>
                    </div>
                    <div class="tools-content">
                        <!-- SVG Import Panel -->
                        <div class="tool-panel active" id="panel-svg-import">
                            <div class="drop-zone" id="svg-drop-zone">
                                <i data-lucide="upload-cloud"
                                    style="width:24px;height:24px;display:block;margin:0 auto 8px"></i>
                                Arraste um SVG aqui ou clique para selecionar
                                <input type="file" accept=".svg" id="svg-file-input" style="display:none">
                            </div>
                            <div class="import-options">
                                <label><input type="number" id="import-width" value="64" min="8" max="256" step="8">
                                    largura</label>
                                <label><input type="checkbox" id="import-dither"> Dithering</label>
                                <label><input type="checkbox" id="import-invert"> Inverter</label>
                            </div>
                        </div>
                        <!-- Export Panel -->
                        <div class="tool-panel" id="panel-export">
                            <div class="export-grid">
                                <button class="btn" onclick="exportScene('c_array')">
                                    <i data-lucide="file-code" style="width:14px;height:14px"></i> C-Array (.h)
                                </button>
                                <button class="btn" onclick="exportScene('delta')">
                                    <i data-lucide="git-branch" style="width:14px;height:14px"></i> Delta (.h)
                                </button>
                                <button class="btn" onclick="exportScene('gif')">
                                    <i data-lucide="film" style="width:14px;height:14px"></i> GIF
                                </button>
                            </div>
                            <div class="import-options" style="margin-top:8px">
                                <label>Formato:
                                    <select id="export-format">
                                        <option value="horizontal">Horizontal (Adafruit)</option>
                                        <option value="vertical">Vertical (ST7565)</option>
                                        <option value="page">Page (U8g2)</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /workspace-code -->

            <!-- CANVAS WORKSPACE -->
            <div id="workspace-canvas" class="workspace" style="background:var(--bg-primary)">
                <div style="display:flex; height:100%; gap:1px; background:var(--border)">
                    <!-- Toolbar -->
                    <div
                        style="width:40px; background:var(--bg-secondary); display:flex; flex-direction:column; align-items:center; padding:8px 0; gap:8px">
                        <button class="tool-btn active" data-tool="pencil" title="Lápis (P)"><i data-lucide="pencil"
                                style="width:16px;height:16px"></i></button>
                        <button class="tool-btn" data-tool="line" title="Linha (L)"><i data-lucide="minus"
                                style="width:16px;height:16px"></i></button>
                        <button class="tool-btn" data-tool="rect" title="Retângulo (R)"><i data-lucide="square"
                                style="width:16px;height:16px"></i></button>
                        <button class="tool-btn" data-tool="circle" title="Círculo (C)"><i data-lucide="circle"
                                style="width:16px;height:16px"></i></button>
                        <button class="tool-btn" data-tool="eraser" title="Borracha (E)"><i data-lucide="eraser"
                                style="width:16px;height:16px"></i></button>
                        <div style="width:20px; height:1px; background:var(--border); margin:4px 0"></div>
                        <button class="tool-btn" id="btn-clear-canvas" title="Limpar"><i data-lucide="trash-2"
                                style="width:16px;height:16px; color:var(--danger)"></i></button>
                        <button class="tool-btn" id="btn-invert-canvas" title="Inverter Cores"><i data-lucide="contrast"
                                style="width:16px;height:16px"></i></button>
                    </div>
                    <!-- Canvas Area -->
                    <div
                        style="flex:1; background:var(--bg-primary); position:relative; overflow:hidden; display:flex; flex-direction:column">
                        <div
                            style="height:32px; border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 8px; justify-content:space-between; font-size:10px; color:var(--text-muted)">
                            <div style="display:flex; gap:8px; align-items:center">
                                Zoom: <select id="canvas-zoom" style="padding:2px">
                                    <option value="1">1x</option>
                                    <option value="2">2x</option>
                                    <option value="4">4x</option>
                                    <option value="8" selected>8x</option>
                                    <option value="16">16x</option>
                                </select>
                                <label><input type="checkbox" id="canvas-grid" checked> Grid</label>
                            </div>
                            <span id="canvas-coords">0, 0</span>
                        </div>
                        <div id="canvas-scroll-area"
                            style="flex:1; overflow:auto; display:flex; justify-content:center; align-items:center; background:#1a1a1a; cursor:crosshair">
                            <canvas id="pixel-canvas" width="128" height="64"
                                style="image-rendering:pixelated; background:white; box-shadow:0 0 20px rgba(0,0,0,0.5)"></canvas>
                        </div>
                    </div>
                    <!-- Properties -->
                    <div
                        style="width:260px; background:var(--bg-secondary); display:flex; flex-direction:column; border-left:1px solid var(--border)">
                        <div class="panel-title" style="padding:12px">Propriedades</div>
                        <div
                            style="padding:0 12px; display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px">
                            <label class="import-options">W <input type="number" id="cv-width" value="128"></label>
                            <label class="import-options">H <input type="number" id="cv-height" value="64"></label>
                        </div>
                        <div class="panel-title" style="padding:12px; border-top:1px solid var(--border)">Gerador de
                            Código</div>
                        <div style="padding:0 12px; display:flex; flex-direction:column; gap:8px; flex:1">
                            <label class="import-options">Plataforma: <select id="cv-platform" style="width:100%">
                                    <option value="adafruit">Adafruit GFX / SSD1306</option>
                                    <option value="u8g2">U8g2 / U8x8</option>
                                    <option value="tft_espi">TFT_eSPI (Sprite)</option>
                                </select></label>
                            <label class="import-options"><input type="checkbox" id="cv-wrapper" checked> Wrapper
                                Func</label>
                            <textarea id="cv-code-output" readonly
                                style="flex:1; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary); font-family:'JetBrains Mono',monospace; font-size:10px; padding:8px; border-radius:4px; resize:none; margin-bottom:12px; white-space:pre"></textarea>
                            <button class="btn btn-sm" onclick="copyCanvasCode()" style="margin-bottom:12px">Copiar
                                Código</button>
                        </div>
                    </div>
                </div>
            </div><!-- /workspace-canvas -->

            <!-- IMAGE2CPP WORKSPACE -->
            <div id="workspace-image2cpp" class="workspace" style="background:var(--bg-primary)">
                <div style="display:flex; gap:16px; height:100%; padding:16px">
                    <!-- Left: Upload & Settings -->
                    <div style="flex:1; display:flex; flex-direction:column; gap:12px; overflow-y:auto">
                        <div class="drop-zone" id="img-drop-zone">
                            <i data-lucide="image-plus"
                                style="width:24px;height:24px;display:block;margin:0 auto 8px"></i>
                            Arraste imagens ou ZIP aqui
                            <input type="file" accept=".png,.jpg,.jpeg,.bmp,.gif,.zip" id="img-file-input" multiple
                                style="display:none">
                        </div>
                        <div class="panel-title">Configurações</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
                            <label class="import-options">Largura <input type="number" id="img-width"
                                    value="128"></label>
                            <label class="import-options">Altura <input type="number" id="img-height"
                                    value="64"></label>
                            <label class="import-options">Threshold <input type="number" id="img-threshold" value="128"
                                    min="0" max="255"></label>
                            <label class="import-options">Rotação <select id="img-rotate">
                                    <option value="0">0°</option>
                                    <option value="90">90°</option>
                                    <option value="180">180°</option>
                                    <option value="270">270°</option>
                                </select></label>
                        </div>
                        <div class="import-options" style="gap:16px">
                            <label>Fundo: <select id="img-bg">
                                    <option value="black">Preto</option>
                                    <option value="white">Branco</option>
                                    <option value="transparent">Transparente</option>
                                </select></label>
                            <label>Escala: <select id="img-scale">
                                    <option value="fit">Fit</option>
                                    <option value="stretch">Esticar</option>
                                    <option value="center">Centralizar</option>
                                    <option value="original">Original</option>
                                </select></label>
                        </div>
                        <div class="import-options" style="gap:16px">
                            <label>Dithering: <select id="img-dither">
                                    <option value="floyd-steinberg">Floyd-Steinberg</option>
                                    <option value="atkinson">Atkinson</option>
                                    <option value="stucki">Stucki</option>
                                    <option value="ordered">Ordered</option>
                                    <option value="simple">Simple</option>
                                </select></label>
                            <label><input type="checkbox" id="img-invert"> Inverter</label>
                        </div>
                        <button class="btn btn-accent" id="btn-convert-img" style="justify-content:center"><i
                                data-lucide="refresh-cw" style="width:14px;height:14px"></i> Converter /
                            Preview</button>
                        <div style="border-top:1px solid var(--border); padding-top:12px">
                            <div class="panel-title">Reverse</div>
                            <textarea id="reverse-hex" placeholder="Cole C-array hexadecimal..."
                                style="width:100%; height:60px; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary); font-family:monospace; font-size:10px; padding:8px; border-radius:4px; resize:none"></textarea>
                            <button class="btn btn-sm" id="btn-reverse" style="margin-top:6px; width:100%">Visualizar
                                Hex</button>
                        </div>
                    </div>
                    <!-- Right: Output -->
                    <div style="flex:1; display:flex; flex-direction:column;">
                        <div class="panel-title">Código Gerado</div>
                        <textarea id="img-output-code" readonly
                            style="flex:1; background:var(--bg-primary); border:1px solid var(--border); color:var(--text-primary); font-family:'JetBrains Mono',monospace; font-size:11px; padding:12px; border-radius:6px; resize:none; margin-bottom:8px"></textarea>
                        <div style="display:flex; gap:8px">
                            <button class="btn btn-sm" onclick="copyToClipboard()">Copiar</button>
                            <span style="flex:1"></span>
                            <div class="import-options" style="margin:0">Draw Mode: <select id="img-draw-mode">
                                    <option value="horizontal">Horizontal</option>
                                    <option value="vertical">Vertical</option>
                                    <option value="page">Page</option>
                                </select></div>
                        </div>
                    </div>
                </div>
            </div><!-- /workspace-image2cpp -->

        </main><!-- /center-panel -->

        <!-- ═══ RIGHT PANEL (Preview + Info) ═══ -->
        <aside class="right-panel">
            <!-- OLED Preview -->
            <div class="panel-block">
                <div class="panel-title">
                    <i data-lucide="monitor" style="width:12px;height:12px"></i> OLED Preview
                </div>
                <div class="oled-frame" id="oled-frame">
                    <div class="oled-screen" id="oled-screen">
                        <img id="preview-img" src="" alt="OLED Preview" style="display:none">
                        <div class="oled-overlay" id="oled-overlay"></div>
                    </div>
                    <div class="empty-state" id="preview-empty" style="padding:40px 20px">
                        <i data-lucide="monitor" style="width:24px;height:24px"></i>
                        Edite o YAML para ver o preview
                    </div>
                </div>
                <div class="color-modes">
                    <div class="color-mode white active" data-color="white" title="Branco"></div>
                    <div class="color-mode blue" data-color="blue" title="Azul"></div>
                    <div class="color-mode yellow" data-color="yellow" title="Amarelo"></div>
                    <div class="color-mode green" data-color="green" title="Verde"></div>
                </div>
                <div class="player-controls" id="player-controls" style="display:none">
                    <button class="btn btn-sm" id="btn-prev" title="Frame anterior">
                        <i data-lucide="skip-back" style="width:12px;height:12px"></i>
                    </button>
                    <button class="btn btn-sm btn-accent" id="btn-play" title="Play/Pause">
                        <i data-lucide="play" style="width:12px;height:12px" id="play-icon"></i>
                    </button>
                    <button class="btn btn-sm" id="btn-next" title="Próximo frame">
                        <i data-lucide="skip-forward" style="width:12px;height:12px"></i>
                    </button>
                    <input type="range" id="frame-slider" min="0" value="0">
                </div>
                <div class="player-info" id="player-info" style="display:none">
                    <span>Frame <span class="accent" id="frame-num">0</span> / <span id="frame-total">0</span></span>
                    <span><span class="accent" id="preview-fps">0</span> FPS</span>
                </div>
            </div>

            <!-- Memory -->
            <div class="panel-block" id="memory-panel" style="display:none">
                <div class="panel-title">
                    <i data-lucide="cpu" style="width:12px;height:12px"></i> Memória ESP32
                </div>
                <div class="memory-bar-container">
                    <div class="memory-bar">
                        <div class="memory-bar-fill" id="memory-fill"></div>
                    </div>
                </div>
                <div class="memory-stats">
                    <div class="memory-stat">
                        <div class="label">Total</div>
                        <div class="value" id="mem-total">0 KB</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Flash Usada</div>
                        <div class="value" id="mem-pct">0%</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Por Frame</div>
                        <div class="value" id="mem-frame">0 B</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Frames</div>
                        <div class="value" id="mem-frames">0</div>
                    </div>
                </div>
            </div>

            <!-- Scene Info -->
            <div class="panel-block" id="scene-info-panel" style="display:none">
                <div class="panel-title">
                    <i data-lucide="info" style="width:12px;height:12px"></i> Informações
                </div>
                <div class="memory-stats">
                    <div class="memory-stat">
                        <div class="label">Resolução</div>
                        <div class="value" id="info-resolution">--</div>
                    </div>
                    <div class="memory-stat">
                        <div class="label">Dimensão</div>
                        <div class="value" id="info-dimension">--</div>
                    </div>
                </div>
            </div>
        </aside>

    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Monaco Loader -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <script>
        // ═══════════════════════════════════════════
        // STATE
        // ═══════════════════════════════════════════
        let editor = null;
        let currentScene = null;
        let frames = [];
        let currentFrame = 0;
        let playing = false;
        let playInterval = null;
        let renderTimeout = null;
        let oledColor = 'white';
        const DEBOUNCE_MS = 600;

        const DEFAULT_YAML = `screen:
  width: 128
  height: 64
  fps: 15
  frames: 30

elements:
  - type: circle
    id: ball
    props:
      cx: 20
      cy: 32
      r: 8
      fill: true
    keyframes:
      - frame: 0
        cx: 20
        easing: "ease-in-out"
      - frame: 15
        cx: 108
      - frame: 29
        cx: 20

output:
  c_array: true
  gif: true
  format: "horizontal"
  delta_compression: true
`;

        // ═══════════════════════════════════════════
        // INIT
        // ═══════════════════════════════════════════
        require.config({
            paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }
        });

        window.MonacoEnvironment = {
            getWorkerUrl: (moduleId, label) =>
                `data:text/javascript;charset=utf-8,${encodeURIComponent(
                    `self.MonacoEnvironment={baseUrl:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/"};importScripts("https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/base/worker/workerMain.js");`
                )}`
        };

        // ═══════════════════════════════════════════
        // WORKSPACE MANAGEMENT
        // ═══════════════════════════════════════════
        window.switchWorkspace = function (name) {
            // 1. Update Tabs
            document.querySelectorAll('.header-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.ws === name);
            });

            // 2. Update Workspaces
            document.querySelectorAll('.workspace').forEach(ws => {
                ws.classList.remove('active');
                if (ws.id === `workspace-${name}`) ws.classList.add('active');
            });

            // 3. Special handling
            if (name === 'code' && editor) {
                setTimeout(() => editor.layout(), 50);
            } else if (name === 'canvas' && window.canvasEditor) {
                if (window.canvasEditor.resize) window.canvasEditor.resize();
            }

            // 4. Update Title
            const titleSpan = document.getElementById('editor-tab');
            if (titleSpan) {
                if (name === 'canvas') titleSpan.textContent = 'Bitmap Editor';
                else if (name === 'image2cpp') titleSpan.textContent = 'Image Converter';
                else if (currentScene) titleSpan.textContent = currentScene;
                else titleSpan.textContent = 'untitled.yaml';
            }
        };

        require(['vs/editor/editor.main'], function () {
            // YAML Theme
            monaco.editor.defineTheme('remotion-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'string', foreground: '00ff88' },
                    { token: 'number', foreground: '44aaff' },
                    { token: 'keyword', foreground: 'ffaa22' },
                    { token: 'comment', foreground: '3a3a50' },
                    { token: 'type', foreground: 'ff4466' },
                ],
                colors: {
                    'editor.background': '#07070d',
                    'editor.foreground': '#e8e8f0',
                    'editorCursor.foreground': '#00ff88',
                    'editor.lineHighlightBackground': '#0d0d1680',
                    'editor.selectionBackground': '#00ff8820',
                    'editorLineNumber.foreground': '#3a3a50',
                    'editorLineNumber.activeForeground': '#6b6b80',
                    'editor.findMatchBackground': '#00ff8830',
                    'editor.findMatchHighlightBackground': '#00ff8815',
                }
            });

            editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: DEFAULT_YAML,
                language: 'yaml',
                theme: 'remotion-dark',
                fontSize: 13,
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                fontLigatures: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                renderLineHighlight: 'gutter',
                lineNumbers: 'on',
                tabSize: 2,
                wordWrap: 'on',
                padding: { top: 12 },
                smoothScrolling: true,
                cursorBlinking: 'smooth',
                cursorSmoothCaretAnimation: 'on',
            });

            // Hot Reload: debounce on content change
            editor.onDidChangeModelContent(() => {
                clearTimeout(renderTimeout);
                setIndicator('rendering');
                renderTimeout = setTimeout(() => renderCurrentYaml(), DEBOUNCE_MS);
            });

            // Initial render
            renderCurrentYaml();
            loadScenes();
            loadAssets();
        });

        // Init Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupDropZone();
            setupToolsTabs();
            setupColorModes();
            setupPlayerControls();
        });

        // ═══════════════════════════════════════════
        // RENDERING
        // ═══════════════════════════════════════════
        async function renderCurrentYaml() {
            const yaml = editor.getValue();
            if (!yaml.trim()) return;

            setStatus('Renderizando...');
            setIndicator('rendering');

            try {
                const res = await fetch('/api/render', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ yaml, scale: 3 }),
                });

                const data = await res.json();

                if (data.error) {
                    setIndicator('error');
                    setStatus(`Erro: ${data.error}`);
                    showToast(data.error, 'error');
                    return;
                }

                frames = data.frames.map(b64 => `data:image/png;base64,${b64}`);
                currentFrame = 0;

                // Update preview
                document.getElementById('preview-empty').style.display = 'none';
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('preview-img').style.width = data.scaled_width + 'px';
                document.getElementById('preview-img').style.height = data.scaled_height + 'px';
                document.getElementById('player-controls').style.display = 'flex';
                document.getElementById('player-info').style.display = 'flex';
                document.getElementById('frame-slider').max = frames.length - 1;
                document.getElementById('frame-total').textContent = frames.length;
                document.getElementById('preview-fps').textContent = data.fps;

                // Update memory
                updateMemory(data.memory);

                // Update scene info
                document.getElementById('scene-info-panel').style.display = 'block';
                document.getElementById('info-resolution').textContent = `${data.width}×${data.height}`;
                document.getElementById('info-dimension').textContent = `${data.scaled_width}×${data.scaled_height}`;

                // Apply color filter
                applyOledColor();
                showFrame(0);

                // Auto-play
                if (!playing) togglePlay();

                setIndicator('ok');
                setStatus(`${frames.length} frames @ ${data.fps} FPS`);

            } catch (err) {
                setIndicator('error');
                setStatus('Erro de conexão');
                showToast('Erro ao renderizar: ' + err.message, 'error');
            }
        }

        function showFrame(i) {
            if (frames.length === 0) return;
            currentFrame = i;
            document.getElementById('preview-img').src = frames[i];
            document.getElementById('frame-slider').value = i;
            document.getElementById('frame-num').textContent = i + 1;
        }

        // ═══════════════════════════════════════════
        // PLAYER
        // ═══════════════════════════════════════════
        function setupPlayerControls() {
            document.getElementById('btn-play').addEventListener('click', togglePlay);
            document.getElementById('btn-prev').addEventListener('click', () => {
                stopPlay();
                showFrame((currentFrame - 1 + frames.length) % frames.length);
            });
            document.getElementById('btn-next').addEventListener('click', () => {
                stopPlay();
                showFrame((currentFrame + 1) % frames.length);
            });
            document.getElementById('frame-slider').addEventListener('input', e => {
                stopPlay();
                showFrame(parseInt(e.target.value));
            });
        }

        function togglePlay() {
            playing = !playing;
            const icon = document.getElementById('play-icon');
            if (playing) {
                icon.setAttribute('data-lucide', 'pause');
                const fps = parseInt(document.getElementById('preview-fps').textContent) || 15;
                playInterval = setInterval(() => {
                    showFrame((currentFrame + 1) % frames.length);
                }, 1000 / fps);
            } else {
                icon.setAttribute('data-lucide', 'play');
                clearInterval(playInterval);
            }
            lucide.createIcons();
        }

        function stopPlay() {
            playing = false;
            clearInterval(playInterval);
            const icon = document.getElementById('play-icon');
            icon.setAttribute('data-lucide', 'play');
            lucide.createIcons();
        }

        // ═══════════════════════════════════════════
        // OLED COLOR
        // ═══════════════════════════════════════════
        function setupColorModes() {
            document.querySelectorAll('.color-mode').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.color-mode').forEach(e => e.classList.remove('active'));
                    el.classList.add('active');
                    oledColor = el.dataset.color;
                    applyOledColor();
                });
            });
        }

        function applyOledColor() {
            const img = document.getElementById('preview-img');
            const colorMap = {
                white: 'none',
                blue: 'sepia(100%) saturate(300%) brightness(70%) hue-rotate(180deg)',
                yellow: 'sepia(100%) saturate(500%) brightness(100%) hue-rotate(10deg)',
                green: 'sepia(100%) saturate(300%) brightness(80%) hue-rotate(90deg)',
            };
            img.style.filter = colorMap[oledColor] || 'none';
        }

        // ═══════════════════════════════════════════
        // MEMORY
        // ═══════════════════════════════════════════
        function updateMemory(mem) {
            if (!mem) return;
            document.getElementById('memory-panel').style.display = 'block';
            document.getElementById('mem-total').textContent = mem.total_kb + ' KB';
            document.getElementById('mem-pct').textContent = mem.flash_pct + '%';
            document.getElementById('mem-frame').textContent = mem.frame_bytes + ' B';
            document.getElementById('mem-frames').textContent = frames.length;

            const fill = document.getElementById('memory-fill');
            fill.style.width = Math.min(mem.flash_pct, 100) + '%';
            fill.classList.toggle('warn', mem.flash_pct > 50);
        }

        // ═══════════════════════════════════════════
        // SCENES
        // ═══════════════════════════════════════════
        async function loadScenes() {
            try {
                const res = await fetch('/api/scenes');
                const scenes = await res.json();
                const list = document.getElementById('scene-list');

                if (scenes.length === 0) {
                    list.innerHTML = '<div class="empty-state"><i data-lucide="folder-open" style="width:16px;height:16px"></i>Nenhuma cena</div>';
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = scenes.map(s => `
          <div class="sidebar-item" data-scene="${s.name}" onclick="openScene('${s.name}')">
            <i data-lucide="file-text" style="width:14px;height:14px;flex-shrink:0"></i>
            <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.name}</span>
            <span class="size">${(s.size / 1024).toFixed(1)}K</span>
          </div>
        `).join('');
                lucide.createIcons();
            } catch (err) {
                console.error('Failed to load scenes:', err);
            }
        }

        async function openScene(name) {
            try {
                const res = await fetch(`/api/scenes/${name}`);
                const data = await res.json();
                editor.setValue(data.content);
                currentScene = name;
                document.getElementById('editor-tab').textContent = name;

                // Highlight sidebar
                document.querySelectorAll('.sidebar-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.scene === name);
                });

                setStatus(`Aberto: ${name}`);
            } catch (err) {
                showToast('Erro ao abrir cena', 'error');
            }
        }

        async function saveCurrentScene() {
            if (!currentScene) {
                const name = prompt('Nome do arquivo (ex: minha_cena.yaml):');
                if (!name) return;
                currentScene = name.endsWith('.yaml') ? name : name + '.yaml';
            }

            try {
                await fetch(`/api/scenes/${currentScene}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: editor.getValue() }),
                });
                document.getElementById('editor-tab').textContent = currentScene;
                showToast(`Salvo: ${currentScene}`, 'success');
                loadScenes();
            } catch (err) {
                showToast('Erro ao salvar', 'error');
            }
        }

        function createNewScene() {
            currentScene = null;
            editor.setValue(DEFAULT_YAML);
            document.getElementById('editor-tab').textContent = 'untitled.yaml';
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
        }

        // ═══════════════════════════════════════════
        // ASSETS
        // ═══════════════════════════════════════════
        async function loadAssets() {
            try {
                const res = await fetch('/api/assets');
                const assets = await res.json();
                const list = document.getElementById('assets-list');

                const images = assets.filter(a => ['.png', '.svg'].includes(a.type));

                if (images.length === 0) {
                    list.innerHTML = '<div class="empty-state"><i data-lucide="image-off" style="width:16px;height:16px"></i>Importe um SVG</div>';
                    lucide.createIcons();
                    return;
                }

                list.innerHTML = '<div class="assets-grid" style="padding:8px">' +
                    images.map(a => `
            <div class="asset-card" onclick="insertAsset('${a.name}')" title="Clique para inserir no YAML">
              <img src="${a.url}" alt="${a.name}">
              <div class="name">${a.name}</div>
            </div>
          `).join('') + '</div>';
                lucide.createIcons();
            } catch (err) {
                console.error('Failed to load assets:', err);
            }
        }

        function insertAsset(name) {
            const snippet = `  - type: sprite\n    id: ${name.replace(/\.[^.]+$/, '')}\n    props:\n      x: 0\n      y: 0\n      src: "assets/${name}"\n`;
            const pos = editor.getPosition();
            editor.executeEdits('', [{
                range: new monaco.Range(pos.lineNumber, 1, pos.lineNumber, 1),
                text: snippet,
            }]);
            showToast(`Asset "${name}" inserido`, 'success');
        }

        // ═══════════════════════════════════════════
        // SVG IMPORT
        // ═══════════════════════════════════════════
        function setupDropZone() {
            const zone = document.getElementById('svg-drop-zone');
            const input = document.getElementById('svg-file-input');

            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                if (e.dataTransfer.files.length) {
                    uploadSVG(e.dataTransfer.files[0]);
                }
            });
            input.addEventListener('change', e => {
                if (e.target.files.length) uploadSVG(e.target.files[0]);
            });
        }

        async function uploadSVG(file) {
            if (!file.name.toLowerCase().endsWith('.svg')) {
                showToast('Apenas arquivos SVG são aceitos', 'error');
                return;
            }

            setStatus('Importando SVG...');
            const formData = new FormData();
            formData.append('file', file);
            formData.append('width', document.getElementById('import-width').value);
            formData.append('dither', document.getElementById('import-dither').checked);
            formData.append('invert', document.getElementById('import-invert').checked);

            try {
                const res = await fetch('/api/svg-import', {
                    method: 'POST',
                    body: formData,
                });

                const data = await res.json();
                if (data.error) {
                    showToast('Erro: ' + data.error, 'error');
                    return;
                }

                // Insert YAML snippet at cursor
                if (data.yaml_snippet) {
                    const pos = editor.getPosition();
                    editor.executeEdits('', [{
                        range: new monaco.Range(pos.lineNumber, 1, pos.lineNumber, 1),
                        text: data.yaml_snippet + '\n',
                    }]);
                }

                showToast(`SVG importado: ${file.name}`, 'success');
                loadAssets();
                setStatus('SVG importado com sucesso');
            } catch (err) {
                showToast('Erro ao importar SVG', 'error');
            }
        }

        // ═══════════════════════════════════════════
        // EXPORT
        // ═══════════════════════════════════════════
        async function exportScene(type) {
            const yaml = editor.getValue();
            setStatus(`Exportando ${type}...`);

            try {
                const res = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        yaml,
                        type,
                        format: document.getElementById('export-format').value,
                    }),
                });

                if (!res.ok) {
                    const err = await res.json();
                    showToast('Erro: ' + (err.error || 'Falha na exportação'), 'error');
                    return;
                }

                // Download
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = res.headers.get('Content-Disposition')?.split('filename=')[1] || `export.${type === 'gif' ? 'gif' : 'h'}`;
                a.click();
                URL.revokeObjectURL(url);

                showToast(`Exportado: ${type}`, 'success');
                setStatus('Pronto');
            } catch (err) {
                showToast('Erro na exportação', 'error');
            }
        }

        // ═══════════════════════════════════════════
        // TOOLS TABS
        // ═══════════════════════════════════════════
        function setupToolsTabs() {
            document.querySelectorAll('.tools-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tools-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tool-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }

        // ═══════════════════════════════════════════
        // UI HELPERS
        // ═══════════════════════════════════════════
        function setStatus(text) {
            document.getElementById('topbar-status').textContent = text;
        }

        function setIndicator(state) {
            const el = document.getElementById('editor-indicator');
            el.className = 'editor-indicator';
            if (state === 'rendering') el.classList.add('rendering');
            else if (state === 'error') el.classList.add('error');
            // 'ok' = default green dot
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ═══════════════════════════════════════════
        // IMAGE2CPP LOGIC
        // ═══════════════════════════════════════════
        function setupImage2CPP() {
            const dropZone = document.getElementById('img-drop-zone');
            const fileInput = document.getElementById('img-file-input');
            const convertBtn = document.getElementById('btn-convert-img');
            const reverseBtn = document.getElementById('btn-reverse');

            // Drag & Drop
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--accent)';
                dropZone.style.background = 'var(--accent-glow)';
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.background = 'transparent';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.background = 'transparent';
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });

            function handleFileSelect() {
                if (fileInput.files.length) {
                    const names = Array.from(fileInput.files).map(f => f.name).join(', ');
                    dropZone.innerHTML = `<i data-lucide="check" style="width:24px;height:24px;display:block;margin:0 auto 8px;color:var(--accent)"></i> ${names}`;
                    lucide.createIcons();
                }
            }

            // Convert
            convertBtn.addEventListener('click', async () => {
                if (!fileInput.files.length) {
                    showToast('Selecione uma imagem ou ZIP primeiro', 'info');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                // Settings
                formData.append('width', document.getElementById('img-width').value);
                formData.append('height', document.getElementById('img-height').value);
                formData.append('background', document.getElementById('img-bg').value);
                formData.append('scale_mode', document.getElementById('img-scale').value);
                formData.append('dither', document.getElementById('img-dither').value);
                formData.append('threshold', document.getElementById('img-threshold').value);
                formData.append('invert', document.getElementById('img-invert').checked);
                formData.append('rotate', document.getElementById('img-rotate').value);

                setStatus('Processando imagem...');

                try {
                    const res = await fetch('/api/image2cpp/convert', {
                        method: 'POST',
                        body: formData
                    });

                    if (!res.ok) throw new Error((await res.json()).error);

                    const data = await res.json();

                    // Show first result in output and preview
                    if (data.results && data.results.length > 0) {
                        const first = data.results[0];
                        // Update Code
                        let code = `// ${first.name} (${first.width}x${first.height})\n`;
                        code += `const unsigned char epd_bitmap_${first.name.replace(/\W/g, '_')} [] PROGMEM = {\n`;

                        // Format C-array
                        const bytes = first.c_array;
                        for (let i = 0; i < bytes.length; i += 16) {
                            const chunk = bytes.slice(i, i + 16);
                            code += '  ' + chunk.map(b => '0x' + b.toString(16).padStart(2, '0').toUpperCase()).join(', ') + ',\n';
                        }
                        code += '};\n';

                        if (data.results.length > 1) {
                            code += `\n// ... e mais ${data.results.length - 1} imagens processadas (ver lógica de batch no image_converter.py)`;
                        }

                        document.getElementById('img-output-code').value = code;

                        // Update Preview
                        document.getElementById('preview-img').src = `data:image/png;base64,${first.preview}`;
                        document.getElementById('preview-img').style.display = 'block';
                        document.getElementById('preview-empty').style.display = 'none';
                        showToast('Imagem convertida com sucesso', 'success');
                    }
                    setStatus('Pronto');

                } catch (e) {
                    showToast('Erro: ' + e.message, 'error');
                    setStatus('Erro');
                }
            });

            // Reverse
            reverseBtn.addEventListener('click', async () => {
                const hex = document.getElementById('reverse-hex').value;
                if (!hex.trim()) return;

                setStatus('Decodificando hex...');
                try {
                    const res = await fetch('/api/image2cpp/reverse', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            hex,
                            width: document.getElementById('img-width').value,
                            height: document.getElementById('img-height').value,
                            mode: document.getElementById('img-draw-mode').value
                        })
                    });
                    if (!res.ok) throw new Error((await res.json()).error);
                    const data = await res.json();

                    document.getElementById('preview-img').src = `data:image/png;base64,${data.preview}`;
                    document.getElementById('preview-img').style.display = 'block';
                    document.getElementById('preview-empty').style.display = 'none';
                    setStatus('Pronto');

                } catch (e) {
                    showToast('Erro: ' + e.message, 'error');
                }
            });
        }

        function copyToClipboard() {
            const el = document.getElementById('img-output-code');
            el.select();
            document.execCommand('copy');
            showToast('Código copiado!', 'success');
        }

        function copyCanvasCode() {
            const el = document.getElementById('cv-code-output');
            el.select();
            document.execCommand('copy');
            showToast('Código copiado!', 'success');
        }

        // ═══════════════════════════════════════════
        // CANVAS EDITOR LOGIC
        // ═══════════════════════════════════════════
        class CanvasEditor {
            constructor(width, height) {
                this.width = width;
                this.height = height;
                this.zoom = 8;
                this.tool = 'pencil';
                this.isDrawing = false;
                this.showGrid = true;

                this.canvas = document.getElementById('pixel-canvas');
                this.ctx = this.canvas.getContext('2d');

                // Offscreen buffer for pixel data (1 = black, 0 = white/transparent)
                this.pixels = new Uint8Array(width * height);

                this.setupEvents();
                this.resize(width, height);
                this.render();
            }

            resize(w, h) {
                this.width = w;
                this.height = h;
                this.pixels = new Uint8Array(w * h); // Clear on resize
                this.updateCanvasSize();
                this.render();
                this.generateCode();
            }

            updateCanvasSize() {
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                this.canvas.style.width = `${this.width * this.zoom}px`;
                this.canvas.style.height = `${this.height * this.zoom}px`;
            }

            setZoom(z) {
                this.zoom = parseInt(z);
                this.updateCanvasSize();
                this.render(); // Re-render grid if needed (browser handles pixelation)
            }

            setTool(t) {
                this.tool = t;
                document.querySelectorAll('.tool-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.tool === t);
                });
            }

            clear() {
                this.pixels.fill(0);
                this.render();
                this.generateCode();
            }

            invert() {
                for (let i = 0; i < this.pixels.length; i++) {
                    this.pixels[i] = this.pixels[i] ? 0 : 1;
                }
                this.render();
                this.generateCode();
            }

            setPixel(x, y, val) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return;
                this.pixels[y * this.width + x] = val;
            }

            getPixel(x, y) {
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return 0;
                return this.pixels[y * this.width + x];
            }

            // Bresenham's Line
            drawLine(x0, y0, x1, y1, val) {
                let dx = Math.abs(x1 - x0);
                let dy = Math.abs(y1 - y0);
                let sx = (x0 < x1) ? 1 : -1;
                let sy = (y0 < y1) ? 1 : -1;
                let err = dx - dy;

                while (true) {
                    this.setPixel(x0, y0, val);
                    if (x0 === x1 && y0 === y1) break;
                    let e2 = 2 * err;
                    if (e2 > -dy) { err -= dy; x0 += sx; }
                    if (e2 < dx) { err += dx; y0 += sy; }
                }
            }

            // Basic shapes
            drawRect(x0, y0, x1, y1, val) {
                const x = Math.min(x0, x1), y = Math.min(y0, y1);
                const w = Math.abs(x1 - x0), h = Math.abs(y1 - y0);
                // Top/Bottom
                for (let i = x; i <= x + w; i++) { this.setPixel(i, y, val); this.setPixel(i, y + h, val); }
                // Left/Right
                for (let i = y; i <= y + h; i++) { this.setPixel(x, i, val); this.setPixel(x + w, i, val); }
            }

            drawCircle(xm, ym, r, val) {
                let x = -r, y = 0, err = 2 - 2 * r;
                do {
                    this.setPixel(xm - x, ym + y, val);
                    this.setPixel(xm - y, ym - x, val);
                    this.setPixel(xm + x, ym - y, val);
                    this.setPixel(xm + y, ym + x, val);
                    r = err;
                    if (r <= y) err += ++y * 2 + 1;
                    if (r > x || err > y) err += ++x * 2 + 1;
                } while (x < 0);
            }

            setupEvents() {
                let startX, startY;
                let tempPixels = null; // Snapshot for shape preview

                const getCoords = (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    return {
                        x: Math.floor((e.clientX - rect.left) / this.zoom),
                        y: Math.floor((e.clientY - rect.top) / this.zoom)
                    };
                };

                this.canvas.addEventListener('mousedown', (e) => {
                    this.isDrawing = true;
                    const { x, y } = getCoords(e);
                    startX = x; startY = y;
                    tempPixels = new Uint8Array(this.pixels); // Snapshot

                    if (this.tool === 'pencil') this.setPixel(x, y, 1);
                    if (this.tool === 'eraser') this.setPixel(x, y, 0);

                    this.render();
                });

                window.addEventListener('mouseup', () => {
                    if (this.isDrawing) {
                        this.isDrawing = false;
                        this.generateCode(); // Update code on finish
                    }
                });

                this.canvas.addEventListener('mousemove', (e) => {
                    const { x, y } = getCoords(e);
                    document.getElementById('canvas-coords').textContent = `${x}, ${y}`;

                    if (!this.isDrawing) return;

                    // Restore snapshot for shapes to avoid trails, except pencil/eraser
                    if (['line', 'rect', 'circle'].includes(this.tool)) {
                        this.pixels.set(tempPixels);
                    }

                    if (this.tool === 'pencil') this.setPixel(x, y, 1);
                    else if (this.tool === 'eraser') this.setPixel(x, y, 0);
                    else if (this.tool === 'line') this.drawLine(startX, startY, x, y, 1);
                    else if (this.tool === 'rect') this.drawRect(startX, startY, x, y, 1);
                    else if (this.tool === 'circle') {
                        const r = Math.floor(Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2)));
                        this.drawCircle(startX, startY, r, 1);
                    }

                    this.render();
                });
            }

            render() {
                const imgData = this.ctx.createImageData(this.width, this.height);
                const data = imgData.data;

                // Background is white (255), Pixel is black (0) usually for e-ink/print, 
                // but for OLED: Background Black, Pixel White.
                // Let's stick to: 1 = Active (Draw Color), 0 = Inactive (Bg Color)
                // We visualize: 1 = Black, 0 = White (Classic paper look) or keep OLED look?
                // Dashboard uses OLED look (Black BG). Let's invert for Canvas Editor to look like paper?
                // Or keep consistency? 
                // Let's go with: 1 = Black (Draw), 0 = White (Empty) for the Editor (easier to see), 
                // OR user preference. Let's force: 1=Black pixel on White canvas for now (classic editor).

                for (let i = 0; i < this.pixels.length; i++) {
                    const val = this.pixels[i] ? 0 : 255; // 1 -> Black, 0 -> White
                    data[i * 4] = val;
                    data[i * 4 + 1] = val;
                    data[i * 4 + 2] = val;
                    data[i * 4 + 3] = 255; // Alpha
                }

                this.ctx.putImageData(imgData, 0, 0);
            }

            generateCode() {
                const platform = document.getElementById('cv-platform').value;
                const wrapper = document.getElementById('cv-wrapper').checked;
                let code = "";

                // Generate XBMP/Bitmap data
                // Horizontal byte mode usually
                let bytes = [];
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x += 8) {
                        let byte = 0;
                        for (let b = 0; b < 8; b++) {
                            if (x + b < this.width && this.pixels[y * this.width + (x + b)]) {
                                if (platform === 'u8g2') byte |= (1 << b); // LSB first for simple XBM? No, XBM is LSB.
                                // Actually most libs use MSB for horizontal.
                                // Let's stick to standard MSB for Adafruit/Generic
                                else byte |= (0x80 >> b);
                            }
                        }
                        bytes.push('0x' + byte.toString(16).padStart(2, '0').toUpperCase());
                    }
                }

                const arrayName = "my_bitmap";
                const byteStr = bytes.join(', ');

                if (platform === 'adafruit') {
                    if (wrapper) code += `void draw(int x, int y) {\n  display.drawBitmap(x, y, ${arrayName}, ${this.width}, ${this.height}, WHITE);\n}\n\n`;
                    code += `const unsigned char ${arrayName}[] PROGMEM = {\n  ${byteStr}\n};`;
                }
                else if (platform === 'u8g2') {
                    // XBM format usually desirable for U8g2 drawXBM
                    if (wrapper) code += `// u8g2.drawXBM(x, y, ${this.width}, ${this.height}, ${arrayName});\n\n`;
                    code += `const uint8_t ${arrayName}[] U8X8_PROGMEM = {\n  ${byteStr}\n};`;
                }
                else if (platform === 'tft_espi') {
                    if (wrapper) code += `// sprite.pushImage(x, y, ${this.width}, ${this.height}, ${arrayName});\n\n`;
                    code += `const uint8_t ${arrayName}[] PROGMEM = {\n  ${byteStr}\n};`;
                }

                document.getElementById('cv-code-output').value = code;
            }
        }

        // Init Canvas Editor
        let canvasEditor;
        function initCanvasEditor() {
            if (canvasEditor) return;
            canvasEditor = new CanvasEditor(128, 64);

            // Bind UI controls
            document.getElementById('cv-width').addEventListener('change', (e) => canvasEditor.resize(parseInt(e.target.value), canvasEditor.height));
            document.getElementById('cv-height').addEventListener('change', (e) => canvasEditor.resize(canvasEditor.width, parseInt(e.target.value)));
            document.getElementById('canvas-zoom').addEventListener('change', (e) => canvasEditor.setZoom(e.target.value));

            document.querySelectorAll('.tool-btn[data-tool]').forEach(b => {
                b.addEventListener('click', () => canvasEditor.setTool(b.dataset.tool));
            });

            document.getElementById('btn-clear-canvas').addEventListener('click', () => canvasEditor.clear());
            document.getElementById('btn-invert-canvas').addEventListener('click', () => canvasEditor.invert());

            document.getElementById('cv-platform').addEventListener('change', () => canvasEditor.generateCode());
            document.getElementById('cv-wrapper').addEventListener('change', () => canvasEditor.generateCode());

            // Grid toggle
            document.getElementById('canvas-grid').addEventListener('change', (e) => {
                // CSS background grid trick
                const grid = e.target.checked;
                canvasEditor.canvas.style.backgroundImage = grid ?
                    'linear-gradient(#ddd 1px, transparent 1px), linear-gradient(90deg, #ddd 1px, transparent 1px)' : 'none';
                canvasEditor.canvas.style.backgroundSize = `${canvasEditor.zoom}px ${canvasEditor.zoom}px`;
            });
            // Trigger grid set
            document.getElementById('canvas-grid').dispatchEvent(new Event('change'));
        }

        // Lazy init when tab is clicked
        document.querySelector('.tools-tab[data-tab="canvas-editor"]').addEventListener('click', () => {
            setTimeout(initCanvasEditor, 100);
        });

        // Init
        setupImage2CPP();
    </script>
</body>

</html>